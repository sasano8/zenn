---
title: "sqlalchemy"
emoji: "ğŸ˜¸" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["markdown", "python"]
published: false
---



# ç’°å¢ƒ
- postgress
- sqlalchemy
- alembic

# åˆ¶ç´„å‘½åãƒ«ãƒ¼ãƒ«
åˆ¶ç´„åã¯ä»¥ä¸‹ã‚’å‚è€ƒã¨ã™ã‚‹ã€‚

## sqlalchemy
- ä¸»ã‚­ãƒ¼: {tablename}_pkey
- ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: {table_name}_{column_name}_key
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ix_{table_name}_{column_name}
- checkåˆ¶ç´„: ?
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¶ç´„: ?
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„: ?

## å€‹äººãƒ«ãƒ¼ãƒ«
- ä¸»ã‚­ãƒ¼: pk_
- ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: uq_
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ix_
- checkåˆ¶ç´„: ck_
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ¶ç´„: df_
- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„: fk_


# ã¯ã˜ã‚ã«

```
import sqlalchemy as sa
from sqlalchemy.ext.declarative import declarative_base
Base = declarative_base()
```

# å…±é€šåŒ–ãƒ»æŠ½è±¡åŒ–ã®åŸºæœ¬
å…±é€šã‚«ãƒ©ãƒ ãƒ»å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»å…±é€šãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ã‚¯ãƒ©ã‚¹é–“ã§å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã‚„ã‚«ã‚¹ã‚¿ãƒ Baseã‚’ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã™ã‚‹ã€‚
å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ä»¥ä¸‹ã‚’å‚ç…§ã€‚

- [ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³](https://docs.sqlalchemy.org/en/13/orm/extensions/declarative/mixins.html)


## NGã‚±ãƒ¼ã‚¹ï¼‘
Baseã‚’ç¶™æ‰¿ã—ãŸã‚¯ãƒ©ã‚¹ã‚’æŠ½è±¡ã‚¯ãƒ©ã‚¹ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã¯ã§ããªã„ã€‚
Baseã‚’ç¶™æ‰¿ã—ãŸéš›ã¯ã€__tablename__ã‚’è¨­å®šã—ã€å…·è±¡åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```
class CommonTable(Base):
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)

# => sqlalchemy.exc.InvalidRequestError: Class <class 'CommonTable'> does not have a __table__ or __tablename__ specified and does not inherit from an existing table-mapped class.
```

## NGã‚±ãƒ¼ã‚¹ï¼’
åˆ¶ç´„åã¯ã€ã‚¹ã‚­ãƒ¼ãƒã§ä¸€æ„ãªãŸã‚ã€å…±é€šåŒ–ã™ã‚‹ã“ã¨ãŒã§ããªã„ã€‚

```
class CommonTable:
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)

__table_args__ = (
  sa.UniqueConstraint("name", name="uq_name"),
)

class Table1(CommonBase, Base):
  __tablename__ = "table1"

class Table2(CommonBase, Base):
  __tablename__ = "table2"

# => sqlalchemy.exc.ProgrammingError: (psycopg2.errors.DuplicateTable) relation "uq_name" already exists
```

## NGã‚±ãƒ¼ã‚¹ï¼“
ã‚±ãƒ¼ã‚¹ï¼’ã¨åŒã˜ãã€‚

```
class CommonTable:
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)

class Table1(CommonBase, Base):
  __tablename__ = "table1"
  __table_args__ = (
    sa.UniqueConstraint("name", name="uq_name"),
  )

class Table2(CommonBase, Base):
  __tablename__ = "table2"
  __table_args__ = (
    sa.UniqueConstraint("name", name="uq_name"),
  )

# => sqlalchemy.exc.ProgrammingError: (psycopg2.errors.DuplicateTable) relation "uq_name" already exists
```

## OKã‚±ãƒ¼ã‚¹ï¼”
åˆ¶ç´„åã¯çœç•¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```
class CommonTable:
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)

class Table1(CommonBase, Base):
  __tablename__ = "table1"
  __table_args__ = (
    sa.UniqueConstraint("name"),
  )
```


## NGã‚±ãƒ¼ã‚¹ï¼•
å…±é€šã‚¯ãƒ©ã‚¹ã«ãŠã‘ã‚‹__targle_args__ç­‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å®£è¨€ã¯ã€@declared_attrã‚’ç”¨ã„ã‚‹ã“ã¨
ãã†ã§ãªã„å ´åˆã€ORMãŒæ„å›³ã‚’æ­£ã—ãè§£é‡ˆã—ãªã„ã€‚

```
class CommonTable:
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)
  __table_args__ = (
    sa.UniqueConstraint("name"),
  )

class Table1(CommonBase, Base):
  __tablename__ = "table1"

class Table2(CommonBase, Base):
  __tablename__ = "table2"


# alembicã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯åŒã˜ãƒ†ãƒ¼ãƒ–ãƒ«ã«åˆ¶ç´„ã‚’ã¤ã‘ã‚ˆã†ã¨ã—ã¦ã„ã‚‹
def upgrade():
  # ### commands auto generated by Alembic - please adjust! ###
  op.create_unique_constraint(None, 'table2', ['name'])
  op.create_unique_constraint(None, 'table2', ['name'])
```



# ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã«ã‚ˆã‚‹å…±é€šåŒ–
ãƒ—ãƒ¬ãƒ¼ãƒ³ãªæŠ½è±¡å®£è¨€ã‚¯ãƒ©ã‚¹ã¨Baseã‚’ãƒŸãƒƒã‚¯ã‚¹ã‚¤ãƒ³ã™ã‚‹ã€‚

## æ–¹æ³•ï¼‘
```
class Common:
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)
  
  __table_args__ = (
    sa.UniqueConstraint("name", name="uix_name"),
  )

class MyTable(Common, Base):
  __tablename__ = "mytable"

```

## æ–¹æ³•ï¼’
```
class CommonBase:
  id = sa.Column(sa.Integer, primary_key=True, index=True)
  name = sa.Column(sa.String(255), nullable=False)

class MyTable(CommonBase, Base):
  __tablename__ = "mytable"

```

# Baseã‚¯ãƒ©ã‚¹æ‹¡å¼µã«ã‚ˆã‚‹å…±é€šåŒ–
```
class Base:
    @declared_attr
    def __tablename__(cls):
        return cls.__name__.lower()

    __table_args__ = {}

    id = Column(Integer, primary_key=True)

Base = declarative_base(cls=Base)

```
