---
title: "pythonの辞書マージ操作を極める"
emoji: "😸" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["markdown", "python"]
published: false
---

# はじめに
pythonにおいて辞書のマージ操作は基礎的な操作です。しかし、著者は泥臭いマージをしていたり、マージの挙動について理解が足りていないと感じるシーンが多かったため、理解を整理するために本記事を執筆しました。

# 検証環境
- python3.9.0

# 用語
本記事では以下の挙動を区別し、執筆しています。（これらの概念の正式名称があれば教えていただけると幸いです。）

## 結合
複数の辞書を１つにまとめる操作。

## マージ
２つの辞書を結合し、かつ、衝突するキーは後勝ちで上書きする操作。

## ユニオン
複数の辞書のキーとバリューを辞書の要素として結合する。辞書は、重複するキーを許可しないため、キー衝突は許可されない。

# 辞書の取り扱い

## ソース辞書
結合対象の辞書として、以下２つ辞書をソースとして利用します。
```
dic1 = {"name": "bob", "age": 20}
dic2 = {"name": "mary"}
```

## 辞書の作成
辞書作成時に複数の辞書から

-----
``` python
{**dic1, **dic2}
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。マージしたいのか、合成したいのか意図が明確でないため好みではない。Python3.5以上でしか使えない模様。

-----
``` python
dict(**dic1, **dic2)
# => TypeError: func() got multiple values for keyword argument 'name'
```
挙動はユニオンとなる。意図は明確でないが、意図せずマージされてしまうことはない。

-----
``` python
def func(**kwargs):
  ...

func(**dic1, **dic2)
# => TypeError: func() got multiple values for keyword argument 'name'
```
挙動はユニオンとなる。意図は明確でないが、意図せずマージされてしまうことはない。


-----
``` python
def func(name, age, **kwargs):
  ...

func(**dic1, **dic2)
# => TypeError: func() got multiple values for keyword argument 'name'
```
挙動はユニオンとなる。重複したキーが、可変長キーワード引数に渡ってくる心配をする必要はない。

-----
``` python
dict(dic1, **dic2)
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。dic1のソースが変更されることはない。

-----
``` python
dic1 | dic2
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。和集合演算子で意図は伝わりやすいので積極的に使いたい。

## 辞書の更新
１つ目の辞書を２つ目の辞書で更新したい場合は、以下の方法を用いる。
破壊的な変更の副作用を考慮したくない場合は、新たな辞書を作成し、新たな変数に格納する方法を用いる。

-----
``` python
dic1.update(dic2)
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。dic1に対して破壊的変更が行われる。

-----
``` python
dic1 |= dic2
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。dic1に対して破壊的変更が行われる。

# まとめ
最後に検証結果と、python3.9以上の環境でどの方法を用いるか個人的ルールをまとめる。

|      | バージョン | コード | 挙動 | 備考 |
| ---- | ---- | ---- | ---- | ---- |
| 作成 | 3.5~ | {\**dic1, \**dic2} | マージ | 使うな |
| 作成 | ? | dict(\**dic1, \**dic2) | ユニオン | マージさせたくない時に意識的に用いる |
| 作成 | ? | func(\**dic1, \**dic2) | ユニオン | マージさせたくない時に意識的に用いる |
| 作成 | ? | dict(dic1, \**dic2) | マージ | 使うな |
| 作成 | 3.9~ | dic1 \| dic2 | マージ | マージしたい時に意識的に用いる |
| 更新 | ? | dic1.update(dic2) | マージ | 使うな |
| 更新 | 3.9~ | dic1 \|= dic2 | マージ | 破壊的変更、かつ、マージしたい時に意識的に用いる |
| ~~更新~~ | | ~~dic1 += dic2~~ | ~~ユニオン~~ | 破壊的変更、かつ、ユニオンに対応する操作は存在しない。 |
