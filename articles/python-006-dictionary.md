---
title: "pythonの辞書マージ操作を極める"
emoji: "😸" # アイキャッチとして使われる絵文字（1文字だけ）
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["markdown", "python"]
published: false
---

# はじめに
pythonにおいて辞書のマージ操作は基礎的な操作です。しかし、著者は泥臭いマージをしていたり、マージの挙動について理解が足りていないと感じるシーンが多かったため、理解を整理するために本記事を執筆しました。

# 検証環境
- python3.9.0

# 用語
本記事では以下の操作を区別し、執筆しています。（これらの概念の正式名称があれば教えていただけると幸いです。）

| 用語 | 概要 |
| :---- | :---- |
| 結合 | 複数の辞書を１つにまとめる。 |
| マージ | 複数の辞書を結合し、かつ、衝突するキーに対しては後勝ちで値を上書きする。 |
| ユニオン | 複数の辞書のキーとバリューを辞書の要素として展開し、結合する。重複するキーは、存在できないためエラーとなる。[^1] |


[^1]: ユニオンオペレーターはマージのことを指していますが、本記事におけるユニオンとはpep584のユニオンと関係ないものとしてください。（適切な単語が思い浮かびませんでした。）

# 辞書の取り扱い

## ソース辞書
結合対象の辞書として、以下２つ辞書をソースとして利用します。
```
dic1 = {"name": "bob", "age": 20}
dic2 = {"name": "mary"}
```

## 辞書の作成
辞書作成時に複数の辞書から

-----
``` python
{**dic1, **dic2}
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。マージしたいのか、合成したいのか意図が明確でないため好みではない。Python3.5以上でしか使えない模様。

-----
``` python
dict(**dic1, **dic2)
# => TypeError: func() got multiple values for keyword argument 'name'
```
挙動はユニオンとなる。意図は明確でないが、意図せずマージされてしまうことはない。

-----
``` python
def func(**kwargs):
  ...

func(**dic1, **dic2)
# => TypeError: func() got multiple values for keyword argument 'name'
```
挙動はユニオンとなる。意図は明確でないが、意図せずマージされてしまうことはない。


-----
``` python
def func(name, age, **kwargs):
  ...

func(**dic1, **dic2)
# => TypeError: func() got multiple values for keyword argument 'name'
```
挙動はユニオンとなる。重複したキーが、可変長キーワード引数に渡ってくる心配をする必要はない。

-----
``` python
dict(dic1, **dic2)
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。dic1のソースが変更されることはない。

-----
``` python
dic1 | dic2
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。和集合演算子で意図は伝わりやすいので積極的に使いたい。

## 辞書の更新
１つ目の辞書を２つ目の辞書で更新したい場合は、以下の方法を用いる。
破壊的な変更の副作用を考慮したくない場合は、新たな辞書を作成し、新たな変数に格納する方法を用いる。

-----
``` python
dic1.update(dic2)
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。dic1に対して破壊的変更が行われる。

-----
``` python
dic1 |= dic2
# => {"name": "mary", "age": 20}
```
挙動はマージとなる。dic1に対して破壊的変更が行われる。

# まとめ
最後に検証結果と、どの方法を用いるか個人的ルールをまとめる。
バージョンを考慮すると話がややこしくなるため、python3.9のみの考慮とする。

| バージョン | コード例 | 挙動 | 備考 |
| ---- | ---- | ---- | ---- |
| 3.5~ | {\**dic1, \**dic2} | 作成/マージ | 使うな |
| ? | dict(\**dic1, \**dic2) | 作成/ユニオン | キーの衝突を想定しない場合に用いる |
| ? | func(\**dic1, \**dic2) | 作成/ユニオン | キーの衝突を想定しない場合に用いる |
| ? | dict(dic1, \**dic2) | 作成/マージ | 使うな |
| 3.9~ | dic1 \| dic2 | 作成/マージ | マージしたい場合に用いる |
| 3.9~ | func(\**(dic1 \| dic2)) | 作成/マージ | マージした辞書をキーワード引数として渡したい場合に用いる |
| ? | dic1.update(dic2) | 更新/マージ | updateにはマージとユニオンの意思が表現されてないため使わない |
| 3.9~ | dic1 \|= dic2 | 更新/マージ | 更新、かつ、マージしたい場合に用いる |
| | ~~dic1 += dic2~~ | ~~更新/ユニオン~~ | 更新、かつ、ユニオンに対応する操作は存在しない |
